<cadmus-current-item-bar></cadmus-current-item-bar>
<mat-card>
  <mat-card-header>
    <div mat-card-avatar>
      <mat-icon>view_headline</mat-icon>
    </div>
    <mat-card-title>Tiles-Based Text Layers</mat-card-title>
  </mat-card-header>
  <mat-card-actions *ngIf="!(loading$ | async)">
    <mat-toolbar>
      <!-- layer selector -->
      <mat-form-field floatLabel="never" style="font-size: 1rem;">
        <mat-select
          *ngIf="layers$ | async as layers"
          placeholder="layer"
          [formControl]="selectedLayer"
        >
          <mat-option *ngFor="let l of layers" [value]="l">{{
            l.name
          }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- buttons -->
      <button
        mat-icon-button
        type="button"
        (click)="editFragment()"
        [disabled]="selectedLayer.invalid"
        matTooltip="Edit the selected fragment"
      >
        <mat-icon>edit</mat-icon>
      </button>
      <button
        mat-icon-button
        type="button"
        color="warn"
        (click)="deleteFragment()"
        [disabled]="selectedLayer.invalid"
        matTooltip="Delete the selected fragment"
      >
        <mat-icon>clear</mat-icon>
      </button>
      <button
        mat-icon-button
        type="button"
        (click)="getCoordsInfo()"
        matTooltip="Get the text coordinates of the selection for a new fragment"
      >
        <mat-icon>info</mat-icon>
      </button>
      <button
        mat-icon-button
        type="button"
        color="primary"
        (click)="addFragment()"
        matTooltip="Add a new fragment at selection"
      >
        <mat-icon>add_circle</mat-icon>
      </button>
      <span>{{ coordsInfo }}</span>
    </mat-toolbar>
  </mat-card-actions>

  <mat-card-content fxLayout="row">
    <div *ngIf="loading$ | async" fxFlex fxLayoutAlign="center center">
      <mat-spinner [diameter]="48" [strokeWidth]="4"></mat-spinner>
    </div>
    <div *ngIf="error$ | async as error" class="error-message">{{ error }}</div>

    <!-- rows -->
    <div *ngIf="rows$ | async as rows">
      <div
        *ngFor="let row of rows; let iy = index"
        fxLayout="row"
        fxLayoutAlign="start center"
      >
        <span class="row-nr">{{ iy + 1 }}</span>
        <!-- tile -->
        <cadmus-text-tile
          *ngFor="let tile of row.tiles || []; let ix = index"
          [tile]="tile"
          [readonly]="true"
          [selected]="tile === selectedTile"
          [checkable]="true"
          [checked]="isTileChecked(iy + 1, ix + 1)"
          [color]="isTileInFragment(iy + 1, ix + 1) ? 'yellow' : 'transparent'"
          fxFlex="none"
          (click)="selectedTile = tile"
          (checkedChange)="onTileChecked(iy + 1, ix + 1, $event)"
        >
        </cadmus-text-tile>
      </div>
    </div>
  </mat-card-content>

  <div>
    <button
      type="button"
      mat-raised-button
      color="warn"
      matTooltip="Close this editor"
      (click)="close()"
    >
      <mat-icon>cancel</mat-icon>
      close
    </button>
  </div>
</mat-card>
